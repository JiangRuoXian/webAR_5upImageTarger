<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>MindAR 5 Targets â€” Debug Build</title>
    <!-- éæ¨¡çµ„ç‰ˆï¼ˆå·²å…§å»º threeï¼‰-->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            background: #000;
            overflow: hidden;
        }

        #app {
            position: fixed;
            inset: 0;
        }

        #toolbar {
            position: fixed;
            left: 12px;
            top: 12px;
            display: flex;
            gap: 8px;
            z-index: 3;
        }

        #toolbar button {
            background: #222;
            color: #fff;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
        }

        #status {
            position: fixed;
            right: 12px;
            top: 12px;
            z-index: 3;
            min-width: 280px;
            max-width: 40vw;
            color: #0f0;
            font: 12px/1.4 monospace;
            background: rgba(0, 0, 0, .65);
            border: 1px solid #0f0;
            border-radius: 10px;
            padding: 10px;
            display: none;
            white-space: pre-wrap;
            overflow: auto;
            max-height: 80vh;
        }

        #log {
            position: fixed;
            left: 12px;
            bottom: 12px;
            z-index: 3;
            width: 40vw;
            max-width: 520px;
            color: #0ff;
            font: 12px/1.4 monospace;
            background: rgba(0, 0, 0, .65);
            border: 1px solid #0ff;
            border-radius: 10px;
            padding: 10px;
            display: none;
            white-space: pre-wrap;
            overflow: auto;
            max-height: 35vh;
        }

        #overlay {
            position: fixed;
            inset: 0;
            display: grid;
            place-items: center;
            gap: 8px;
            z-index: 5;
            background: radial-gradient(ellipse at center, rgba(0, 0, 0, .7) 0%, rgba(0, 0, 0, .9) 100%);
            color: #fff;
            text-align: center;
            padding: 24px;
        }

        #overlay button {
            padding: 10px 16px;
            font-size: 16px;
            border-radius: 10px;
            border: 0;
            cursor: pointer;
        }

        .muted {
            color: #aaa
        }

        .ok {
            color: #6f6
        }

        .warn {
            color: #fc6
        }

        .err {
            color: #f66
        }

        .chip {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid #444;
            margin: 0 4px 4px 0;
        }

        #targetsPanel {
            position: fixed;
            right: 12px;
            bottom: 12px;
            z-index: 4;
            display: none;
            /* é»æŒ‰éˆ•æ‰æ‰“é–‹ */
            background: rgba(0, 0, 0, .8);
            border: 1px solid #888;
            border-radius: 10px;
            padding: 10px;
            max-width: 40vw;
            max-height: 40vh;
            overflow: auto;
        }

        #targetsPanel .item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        #targetsPanel img {
            width: 120px;
            height: auto;
            border-radius: 6px;
            border: 1px solid #444;
        }

        #targetsPanel .idx {
            font: 12px/1.2 monospace;
            color: #ccc;
            padding: 2px 6px;
            border: 1px solid #555;
            border-radius: 6px;
        }

        #log {
            display: block;
        }

        /* â† è®“ log é¢æ¿é è¨­å¸¸é§ */
    </style>
</head>

<body>
    <div id="app"></div>

    <div id="toolbar">
        <button id="btnStart">Start AR</button>
        <button id="btnToggleDebug">Toggle Debug</button>
        <button id="btnShowTargets">Show Targets</button>
        <button id="btnRetry">Retry</button>
    </div>

    <div id="targetsPanel"></div>

    <div id="status"></div>
    <div id="log"></div>

    <div id="overlay">
        <div>
            <h2>MindAR Debug Demoï¼ˆ5 Targetsï¼‰</h2>
            <div id="precheck" class="muted">æ­£åœ¨é æª¢ç’°å¢ƒâ€¦</div>
            <p class="muted">è«‹æº–å‚™å¥½ä½ çš„ 5 å¼µ target åœ–ç‰‡ï¼ˆé †åº = ç·¨è­¯æ™‚ä¸Šå‚³é †åºï¼‰</p>
            <div style="margin-top:12px">
                <button id="btnStartOverlay">å…è¨±ä½¿ç”¨ç›¸æ©Ÿä¸¦é–‹å§‹</button>
            </div>
            <div class="muted" style="margin-top:8px">è‹¥ç„¡åæ‡‰ï¼Œè©¦æŒ‰å³ä¸Šè§’ã€ŒToggle Debugã€æŸ¥çœ‹</div>
        </div>
    </div>

    <script>
        // ====== å¯èª¿åƒæ•¸ ======
        const TARGETS_PATH = './targets.mind'; // æ”¾åŒç›®éŒ„å³å¯
        const MAX_TRACK = 5;
        const COLORS = [0xff5555, 0x55ff55, 0x5599ff, 0xffcc33, 0xcc66ff]; // æ¯å€‹ target çš„çƒè‰²
        const ENABLE_AXES = true; // æ¯å€‹ target é¡¯ç¤ºå°åº§æ¨™è»¸

        // ä¾ã€Œç·¨è­¯æ™‚ä¸Šå‚³é †åºã€å¡«å…¥åŸå§‹åœ–çš„ç¶²å€æˆ–ç›¸å°è·¯å¾‘ï¼š0..4
        const TARGET_IMAGES = [
            './img/1.png',
            './img/2.png',
            './img/3.png',
            './img/4.png',
            './img/5.png',
        ];

        // ====== DOM ä¾¿æ· ======
        const $ = (sel) => document.querySelector(sel);
        const statusEl = $('#status');
        const logEl = $('#log');
        const overlayEl = $('#overlay');
        const btnStart = $('#btnStart');
        const btnStartOverlay = $('#btnStartOverlay');
        const btnDebug = $('#btnToggleDebug');
        const btnRetry = $('#btnRetry');
        const precheckEl = $('#precheck');

        // ====== æ—¥èªŒ & ç‹€æ…‹ ======
        const logs = [];
        function log(...args) {
            const line = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
            logs.push(line);
            if (logEl.style.display !== 'none') logEl.textContent = logs.slice(-200).join('\n');
            console.log('[LOG]', ...args);
        }
        function setStatus(txt) {
            statusEl.textContent = txt;
        }
        function toggleDebug(force) {
            const show = (typeof force === 'boolean') ? force : (statusEl.style.display === 'none');
            statusEl.style.display = show ? 'block' : 'none';
            // ä¿æŒ log å¸¸é§
            if (logEl.style.display !== 'block') logEl.style.display = 'block';
        }
        // URL ?debug=1 è‡ªå‹•æ‰“é–‹
        if (new URLSearchParams(location.search).get('debug') === '1') toggleDebug(true);

        // å…¨åŸŸéŒ¯èª¤æ””æˆª
        window.addEventListener('error', (e) => {
            log('[ERROR]', e.message, e.filename, e.lineno + ':' + e.colno);
        });
        window.addEventListener('unhandledrejection', (e) => {
            log('[UNHANDLED REJECTION]', String(e.reason || e));
        });

        // ====== å•Ÿå‹•æµç¨‹ ======
        let mindarThree, renderer, scene, camera, anchors = [], started = false;
        let fpsInfo = { last: performance.now(), frames: 0, fps: 0 };

        // é æª¢ï¼šHTTPS / ç›¸æ©Ÿ / æª”æ¡ˆå¯è®€
        async function preflightCheck() {
            const bits = [];
            // å®‰å…¨ç’°å¢ƒ
            if (!window.isSecureContext && location.hostname !== 'localhost') {
                bits.push('âŒ é HTTPS å®‰å…¨ç’°å¢ƒï¼ˆè¡Œå‹•è£ç½®ç›¸æ©Ÿå¯èƒ½ç„¡æ³•é–‹å•Ÿï¼‰');
            } else {
                bits.push('âœ… å®‰å…¨ç’°å¢ƒï¼ˆHTTPS or localhostï¼‰');
            }
            // MediaDevices
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                bits.push('âŒ ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿ API');
            } else {
                bits.push('âœ… æ”¯æ´ç›¸æ©Ÿ API');
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const cams = devices.filter(d => d.kind === 'videoinput');
                    bits.push(`ğŸ“· å¯ç”¨ç›¸æ©Ÿï¼š${cams.length} å°`);
                } catch (err) {
                    bits.push('âš ï¸ enumerateDevices å¤±æ•—ï¼ˆå¯èƒ½éœ€æ¬Šé™ï¼‰');
                    log('enumerateDevices error:', err);
                }
            }
            // æª”æ¡ˆæ˜¯å¦å¯è®€ + æª”æ¡ˆå¤§å°
            try {
                const res = await fetch(TARGETS_PATH, { method: 'GET' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const blob = await res.blob();
                bits.push(`âœ… è®€åˆ° targets.mindï¼ˆ${(blob.size / 1024).toFixed(1)} KBï¼‰`);
            } catch (err) {
                bits.push(`âŒ ç„¡æ³•è®€å– ${TARGETS_PATH}ï¼ˆ${String(err)}ï¼‰`);
                log('fetch targets.mind failed:', err);
            }
            precheckEl.innerHTML = bits.join('<br>');
        }

        // å»ºç«‹å ´æ™¯ + 5 å€‹ anchor
        async function setupMindAR() {
            log('åˆå§‹åŒ– MindARThreeâ€¦');
            mindarThree = new window.MINDAR.IMAGE.MindARThree({
                container: $('#app'),
                imageTargetSrc: TARGETS_PATH,
                maxTrack: MAX_TRACK,
            });
            ({ renderer, scene, camera } = mindarThree);

            const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
            scene.add(hemi);

            anchors = [];
            for (let i = 0; i < MAX_TRACK; i++) {
                const anchor = mindarThree.addAnchor(i);

                const group = new THREE.Group();

                const mat = new THREE.MeshStandardMaterial({ color: COLORS[i % COLORS.length], metalness: 0.0, roughness: 0.7 });
                const mesh = new THREE.Mesh(new THREE.SphereGeometry(0.05, 16, 16), mat);
                mesh.position.set(0, 0.055, 0);
                group.add(mesh);

                if (ENABLE_AXES) {
                    const axes = new THREE.AxesHelper(0.15); // x=ç´… y=ç¶  z=è—
                    axes.position.set(0, 0.001, 0);
                    group.add(axes);
                }

                anchor.group.add(group);

                // äº‹ä»¶ï¼šfound / lost
                anchor.onTargetFound = () => log(`FOUND #${i}`);
                anchor.onTargetLost = () => log(`LOST  #${i}`);

                anchors.push(anchor);
            }
        }

        // ä»¥ä½¿ç”¨è€…æ‰‹å‹¢å•Ÿå‹•ï¼ˆå¿…è¦ï¼‰
        async function startAR() {
            if (started) return;
            started = true;

            overlayEl.style.display = 'none';
            log('é–‹å§‹ start()â€¦ï¼ˆè‹¥å¡ä½ï¼ŒæŸ¥çœ‹ç€è¦½å™¨æ˜¯å¦å½ˆå‡ºç›¸æ©Ÿæ¬Šé™è¦–çª—ï¼‰');

            try {
                await mindarThree.start(); // æ˜ç¢ºæ§åˆ¶
            } catch (err) {
                started = false;
                overlayEl.style.display = 'grid';
                log('mindarThree.start() å¤±æ•—ï¼š', err);
                alert('å•Ÿå‹•å¤±æ•—ï¼š' + err);
                return;
            }

            renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
                // FPS è¨ˆ
                fpsInfo.frames++;
                const now = performance.now();
                if (now - fpsInfo.last >= 1000) {
                    fpsInfo.fps = fpsInfo.frames;
                    fpsInfo.frames = 0;
                    fpsInfo.last = now;
                }
                // ç‹€æ…‹é¢æ¿
                const lines = [];
                lines.push(`FPS: ${fpsInfo.fps}`);
                lines.push(`Anchors: ${anchors.length} / maxTrack=${MAX_TRACK}`);
                for (let i = 0; i < anchors.length; i++) {
                    const g = anchors[i].group;
                    let pos = new THREE.Vector3();
                    g.getWorldPosition(pos);
                    // èˆ‡ç›¸æ©Ÿè·é›¢
                    let camPos = new THREE.Vector3();
                    camera.getWorldPosition(camPos);
                    const dist = pos.distanceTo(camPos);
                    lines.push(`[#${i}] visible=${g.visible ? 'Y' : 'N'}  pos=(${pos.x.toFixed(2)},${pos.y.toFixed(2)},${pos.z.toFixed(2)})  camDist=${dist.toFixed(2)}m`);
                }
                setStatus(lines.join('\n'));
            });

            log('start() å®Œæˆï¼Œé–‹å§‹è¿½è¹¤ã€‚');
        }

        // é‡è©¦ï¼ˆé‡æ–°æ•´ç†æœ€ä¹¾è„†ï¼‰
        function retry() {
            location.reload();
        }

        // ====== ç¶å®š UI ======
        btnStart.addEventListener('click', startAR);
        btnStartOverlay.addEventListener('click', startAR);
        // btnDebug.addEventListener('click', () => toggleDebug());
        btnRetry.addEventListener('click', retry);

        // é æª¢ + å»ºç«‹å ´æ™¯
        (async function main() {
            await preflightCheck();
            await setupMindAR();
            // è‹¥ä½¿ç”¨è€…å¸¶ ?debug=1ï¼Œè‡ªå‹•é–‹å•Ÿé¢æ¿
            if (new URLSearchParams(location.search).get('debug') === '1') toggleDebug(true);
        })();

        const btnShowTargets = $('#btnShowTargets');
        const targetsPanel = $('#targetsPanel');

        // å»ºç«‹åœ–åº«æ¸…å–®ï¼ˆä¾ TARGET_IMAGESï¼‰
        function buildTargetsPanel() {
            targetsPanel.innerHTML = '<div style="color:#fff;margin-bottom:6px;">Targets Preview (é †åº = index)</div>';
            TARGET_IMAGES.forEach((src, i) => {
                const row = document.createElement('div');
                row.className = 'item';
                row.innerHTML = `
      <span class="idx">#${i}</span>
      <img src="${src}" alt="target_${i}">
      <span style="color:#aaa">${src}</span>
    `;
                targetsPanel.appendChild(row);
            });
        }

        // é¡¯ç¤º/éš±è—åœ–åº«
        function toggleTargetsPanel() {
            if (!targetsPanel.hasChildNodes()) buildTargetsPanel();
            targetsPanel.style.display = (targetsPanel.style.display === 'none' || !targetsPanel.style.display)
                ? 'block' : 'none';
        }

        // ç¶å®š
        btnShowTargets.addEventListener('click', toggleTargetsPanel);

        // å¦å¤–ï¼Œè®“ debug é¢æ¿ä»å¯æ‰‹å‹•åˆ‡ï¼šä½† log å·²é è¨­é¡¯ç¤º
        btnDebug.addEventListener('click', () => toggleDebug());
    </script>
</body>

</html>