<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Minimal WebAR Camera â€” Debug</title>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            background: #000;
            overflow: hidden
        }

        #hud {
            position: fixed;
            left: 10px;
            top: 10px;
            z-index: 10;
            color: #fff;
            background: rgba(0, 0, 0, .65);
            padding: 8px 10px;
            border-radius: 10px;
            font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            white-space: pre-wrap
        }

        #btn {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 12px 20px;
            font-size: 20px;
            border: 0;
            border-radius: 12px;
            background: #28a745;
            color: #fff;
            cursor: pointer;
            z-index: 10;
            touch-action: manipulation;
            user-select: none
        }

        canvas {
            display: block
        }
    </style>

    <!-- ========== â‘  è«‹äºŒé¸ä¸€ï¼šCDN æˆ– æœ¬åœ°æª” ==========
       A. å¦‚æœä½ ç”¨ CDNï¼ˆç¶²è·¯åˆ¥æ“‹ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-three.prod.js"></script>

    <!-- B. å¦‚æœä½ ç”¨æœ¬åœ°æª”ï¼Œæ”¹æˆä¸‹é¢å…©è¡Œï¼ˆä¸¦åˆªä¸Šé¢å…©è¡Œï¼‰
  <script src="./libs/three.min.js"></script>
  <script src="./libs/mindar-image-three.prod.js"></script>
  -->
</head>

<body>
    <div id="hud">Bootingâ€¦</div>
    <button id="btn">â–¶ Start AR</button>

    <script>
        const hud = document.getElementById('hud');
        const log = (...a) => { hud.textContent += '\\n' + a.join(' '); console.log(...a); };
        const set = (t) => { hud.textContent = t; console.log(t); };

        // é–‹å ´è‡ªæª¢ï¼šæ˜¯å¦è¼‰åˆ° THREE / MINDAR
        window.addEventListener('load', () => {
            set('Bootingâ€¦');
            log('THREE =', typeof window.THREE);
            log('MINDAR =', typeof window.MINDAR);
            log('MINDAR.IMAGE =', window.MINDAR && typeof window.MINDAR.IMAGE);
            if (!window.THREE) log('âŒ THREE æ²’è¼‰åˆ°ï¼ˆæª¢æŸ¥ <script> è·¯å¾‘/ç¶²è·¯ï¼‰');
            if (!window.MINDAR || !window.MINDAR.IMAGE) log('âŒ MINDAR three ç‰ˆæ²’è¼‰åˆ°ï¼ˆè¦ mindar-image-three.prod.jsï¼‰');
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                log('âš ï¸ éœ€è¦ HTTPS æˆ– localhost æ‰èƒ½ç”¨ç›¸æ©Ÿ');
            }
        });

        async function requestCameraOnce() {
            // å…ˆç”¨ getUserMedia å–ä¸€æ¬¡æµï¼Œç¢ºä¿æ¬Šé™ OKï¼Œå†ç«‹åˆ»é—œæ‰
            try {
                log('è¦æ±‚ç›¸æ©Ÿæ¬Šé™ï¼ˆé æª¢ï¼‰â€¦');
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false });
                const track = stream.getVideoTracks()[0];
                log('âœ… é æª¢æˆåŠŸï¼š', track.label || '(ç„¡è£ç½®åç¨±)');
                track.stop(); // é—œæ‰é æª¢æµ
                return true;
            } catch (e) {
                log('âŒ ç›¸æ©Ÿé æª¢å¤±æ•—ï¼š', e.name || e.message || e);
                return false;
            }
        }

        let started = false;
        async function startAR() {
            if (started) return; started = true;
            set('å•Ÿå‹•ä¸­â€¦');

            // å…ˆé æª¢ç›¸æ©Ÿï¼Œé¿å… start() å¡ä½
            const ok = await requestCameraOnce();
            if (!ok) { set('å¤±æ•—ï¼šç€è¦½å™¨æœªæˆæ¬Šæˆ–ç„¡ç›¸æ©Ÿ'); started = false; return; }

            // å»ºç«‹ MindARThreeï¼ˆä¸æ”¾ targets ä¹Ÿæœƒæœ‰ç›¸æ©ŸèƒŒæ™¯ï¼‰
            if (!window.MINDAR || !window.MINDAR.IMAGE) {
                set('å¤±æ•—ï¼šMINDAR three ç‰ˆæœªè¼‰å…¥ï¼ˆæª¢æŸ¥æª”æ¡ˆä¾†æºï¼‰');
                started = false; return;
            }

            const mindarThree = new window.MINDAR.IMAGE.MindARThree({
                container: document.body,
                captureMode: 'environment' // å¾Œé¡é ­
                // å¦‚è¦æ¸¬åœ–ç‰‡ï¼Œä¹‹å¾ŒåŠ ï¼šimageTargetSrc: './targets.mind'
            });

            const { renderer, scene, camera } = mindarThree;
            scene.add(new THREE.HemisphereLight(0xffffff, 0x222222, 1.0));

            try {
                log('â–¶ å‘¼å« mindarThree.start() â€¦');
                await mindarThree.start();
                set('å·²å•Ÿå‹• âœ”ï¼ˆæ‡‰çœ‹åˆ°ç›¸æ©Ÿï¼‰');
                document.getElementById('btn')?.remove();

                // é¡¯ç¤ºä¸€ä¸‹ MindAR ç”Ÿæˆçš„ <video> ç‹€æ…‹
                setTimeout(() => {
                    const v = document.querySelector('video');
                    if (!v) { log('âš ï¸ æ‰¾ä¸åˆ° video å…ƒç´ '); return; }
                    const track = v.srcObject && v.srcObject.getVideoTracks ? v.srcObject.getVideoTracks()[0] : null;
                    log('ğŸ¥ video.readyState =', v.readyState, 'paused =', v.paused);
                    if (track) {
                        const st = track.getSettings?.() || {};
                        log('ğŸ› track settings =', JSON.stringify(st));
                    }
                }, 300);

                renderer.setAnimationLoop(() => renderer.render(scene, camera));
            } catch (e) {
                set('å¤±æ•—ï¼š' + (e && (e.message || e)));
                started = false;
                log('ğŸ‘‰ å¸¸è¦‹åŸå› ï¼š1) æª”æ¡ˆæ²’è¼‰åˆ°ï¼ˆCDN è¢«æ“‹/è·¯å¾‘éŒ¯ï¼‰ 2) é HTTPS 3) è£ç½®/ç€è¦½å™¨ä¸æ”¯æ´');
            }
        }

        const btn = document.getElementById('btn');
        const go = (ev) => { ev.preventDefault(); ev.stopPropagation(); startAR(); };
        btn.addEventListener('click', go, { passive: false });
        btn.addEventListener('pointerdown', go, { passive: false });
        document.addEventListener('pointerdown', e => { if (!started) go(e); }, { once: true });
    </script>
</body>

</html>