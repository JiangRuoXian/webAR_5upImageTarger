<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
    <title>MindAR 5 Targets â€” Debug</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #hud {
            position: fixed;
            left: 8px;
            top: 8px;
            z-index: 10;
            max-width: min(92vw, 600px);
            background: rgba(0, 0, 0, .65);
            color: #fff;
            padding: 10px 12px;
            border-radius: 12px;
            font: 13px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
            white-space: pre-wrap;
            word-break: break-word;
        }

        #startBtn {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            padding: 14px 24px;
            background: #28a745;
            color: #fff;
            border: 0;
            border-radius: 12px;
            z-index: 2147483647;
            pointer-events: auto;
            cursor: pointer;
            touch-action: manipulation;
            user-select: none;
        }
    </style>
</head>

<body>
    <div id="hud">Bootingâ€¦</div>
    <button id="startBtn">â–¶ Start AR</button>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; autoStart: false"
        renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true" embedded
        vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: true">
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0"></a-entity>
        <a-entity mindar-image-target="targetIndex: 1"></a-entity>
        <a-entity mindar-image-target="targetIndex: 2"></a-entity>
        <a-entity mindar-image-target="targetIndex: 3"></a-entity>
        <a-entity mindar-image-target="targetIndex: 4"></a-entity>
    </a-scene>

    <script>
        const hud = document.getElementById('hud');
        const startBtn = document.getElementById('startBtn');
        const sceneEl = document.querySelector('a-scene');
        const log = (...a) => { hud.textContent += '\n' + a.join(' '); console.log(...a); };
        const set = (t) => { hud.textContent = t; console.log(t); };

        // è®€æª”æª¢æŸ¥
        (async () => {
            set('Checking ./targets.mind â€¦0.7.2');
            try {
                const r = await fetch('./targets.mind', { cache: 'no-store' });
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const buf = await r.arrayBuffer();
                log(`OK, size=${(buf.byteLength / 1024).toFixed(1)} KB`);
            } catch (e) {
                log('âŒ ç„¡æ³•è®€å– targets.mindï¼š', String(e));
            }
        })();

        // å•Ÿå‹•å™¨ï¼ˆå”¯ä¸€ç‰ˆæœ¬ï¼‰
        let starting = false, started = false, pollId = null;

        if (!window.MINDAR) {
            log('âŒ MINDAR æœªè¼‰å…¥ï¼ˆè«‹æª¢æŸ¥ CDN è·¯å¾‘æˆ–æ”¹ç”¨æœ¬åœ°æª”ï¼‰');
        }
        async function waitAndStart() {
            if (starting || started) return;
            starting = true;
            set('Starting ARâ€¦ï¼ˆç­‰å¾…ç³»çµ±å°±ç·’ï¼‰');
            log('ğŸ‘† click received, pollingâ€¦');

            pollId = setInterval(async () => {
                const aframeReady = !!window.AFRAME;
                const sceneReady = !!(sceneEl && sceneEl.hasLoaded);
                const sys = sceneEl?.systems?.['mindar-image-system'];

                if (!aframeReady) { log('âŒ› AFRAME å°šæœªè¼‰å…¥â€¦'); return; }
                if (!sceneReady) { log('âŒ› scene å°šæœª loadedâ€¦'); return; }
                if (!sys) { log('âŒ› mindar-image-system å°šæœªå°±ç·’â€¦'); return; }

                clearInterval(pollId);
                try {
                    await sys.start();
                    started = true;
                    log('âœ… AR started');
                    startBtn.remove();
                } catch (e) {
                    starting = false;
                    log('âŒ start å¤±æ•—ï¼š', e);
                }
            }, 200);
        }

        // æ‰‹å‹¢äº‹ä»¶ï¼šä¸€é–‹å§‹å°±ç¶
        const gesture = ev => { try { ev.stopPropagation(); ev.preventDefault(); } catch (_) { } waitAndStart(); };
        startBtn.addEventListener('click', gesture, { passive: false });
        startBtn.addEventListener('pointerdown', gesture, { passive: false });
        startBtn.addEventListener('touchend', gesture, { passive: false });
        document.addEventListener('pointerdown', () => { if (!started) waitAndStart(); }, { once: true });

        // è‰²ç›¤ + ç›®æ¨™
        const PALETTE = ['#e74c3c', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#e67e22', '#1abc9c', '#e84393', '#16a085', '#d35400'];
        const colors = (() => { const p = [...PALETTE], out = []; for (let i = 0; i < 5; i++) out.push(p.splice(Math.floor(Math.random() * p.length), 1)[0]); return out; })();
        const targets = Array.from(document.querySelectorAll('[mindar-image-target]'));
        const spawned = new Array(5).fill(null);

        // scene loaded å¾Œå†ç¶ found/lost èˆ‡ç‹€æ…‹æç¤ºï¼ˆä¸å‘¼å« startï¼‰
        sceneEl.addEventListener('loaded', () => {
            log('A-Frame loaded');
            sceneEl.addEventListener('arReady', () => log('âœ… arReadyï¼ˆç®¡ç·šå•Ÿå‹•ï¼‰'));
            sceneEl.addEventListener('arError', e => log('âŒ arErrorï¼š', e?.detail || 'unknown'));

            targets.forEach((t, idx) => {
                t.addEventListener('targetFound', () => {
                    log(`found #${idx}`);
                    if (!spawned[idx]) {
                        const s = document.createElement('a-sphere');
                        s.setAttribute('position', '0 0 -0.08');
                        s.setAttribute('radius', '0.035');
                        s.setAttribute('segments-width', '32');
                        s.setAttribute('segments-height', '32');
                        s.setAttribute('material', `color:${colors[idx]}`);
                        t.appendChild(s);
                        spawned[idx] = s;
                    }
                });
                t.addEventListener('targetLost', () => {
                    log(`lost  #${idx}`);
                    if (spawned[idx]) { spawned[idx].remove(); spawned[idx] = null; }
                });
            });
        });

        // æŠ“å…¨åŸŸéŒ¯èª¤
        window.addEventListener('error', e => log('ğŸ§¯ window.onerror:', e.message));
        window.addEventListener('unhandledrejection', e => log('ğŸ§¯ unhandledrejection:', String(e.reason)));

        // é¡å¤–æ¸¬ç›¸æ©Ÿæ¬Šé™
        navigator.mediaDevices?.getUserMedia({ video: true })
            .then(() => log('âœ… ç€è¦½å™¨å…è¨±ç›¸æ©Ÿï¼ˆæ¸¬è©¦ç”¨ï¼‰'))
            .catch(err => log('âš ï¸ ç›¸æ©Ÿæ¬Šé™è¢«æ‹’/ç„¡æ³•å–å¾—ï¼š', err?.name));

        // === Camera Preview + Force Bind to MindAR ===
        (function () {
            const hud = document.getElementById('hud');
            const sceneEl = document.querySelector('a-scene');
            const log = (...a) => { hud.textContent += '\n' + a.join(' '); console.log(...a); };

            // 1) UI
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Preview Camera';
            Object.assign(prevBtn.style, { marginTop: '6px', padding: '6px 10px', borderRadius: '8px', border: '0', cursor: 'pointer' });
            hud.appendChild(prevBtn);

            const bindBtn = document.createElement('button');
            bindBtn.textContent = 'Bind Preview â†’ MindAR';
            Object.assign(bindBtn.style, { marginLeft: '6px', padding: '6px 10px', borderRadius: '8px', border: '0', cursor: 'pointer' });
            hud.appendChild(bindBtn);

            // 2) é–‹ä¸€å€‹é è¦½ <video>
            let previewEl = null;
            prevBtn.onclick = async () => {
                try {
                    if (!previewEl) {
                        previewEl = document.createElement('video');
                        previewEl.id = 'previewCam';
                        Object.assign(previewEl.style, {
                            position: 'fixed', right: '8px', bottom: '8px', width: '160px', height: '120px',
                            background: '#222', zIndex: 99999, border: '1px solid #555', borderRadius: '8px'
                        });
                        previewEl.muted = true; previewEl.autoplay = true; previewEl.playsInline = true;
                        document.body.appendChild(previewEl);
                    }
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: { ideal: 'environment' } }, audio: false
                    });
                    previewEl.srcObject = stream;
                    await previewEl.play().catch(() => { });
                    log('âœ… Preview é–‹å•Ÿï¼š', 'videoWidth=', previewEl.videoWidth, 'videoHeight=', previewEl.videoHeight);
                } catch (e) {
                    log('âŒ getUserMedia å¤±æ•—ï¼š', e && e.name ? e.name : String(e));
                }
            };

            // 3) æŠŠé è¦½ <video> å¼·åˆ¶æŒ‡å®šçµ¦ MindAR çš„ system
            bindBtn.onclick = async () => {
                try {
                    const sys = sceneEl.systems && sceneEl.systems['mindar-image-system'];
                    if (!sys) { log('âŒ mindar-image-system å°šæœªå°±ç·’'); return; }
                    if (!previewEl || !previewEl.srcObject) { log('âŒ æ²’æœ‰å¯ç”¨çš„é è¦½å½±ç‰‡æµï¼Œå…ˆæŒ‰ Preview Camera'); return; }

                    // è‹¥ MindAR è£¡æ²’æœ‰ videoï¼Œå°±ç›´æ¥å¡æˆ‘å€‘çš„
                    sys.video = previewEl;

                    // å¦‚æœå·²æœ‰ VideoTextureï¼Œæ”¹å®ƒçš„ä¾†æºï¼›è‹¥æ²’æœ‰å°±å‰µä¸€å€‹
                    const THREE = window.THREE || window.AFRAME?.THREE;
                    if (!THREE) { log('âŒ THREE æœªè¼‰å…¥'); return; }
                    if (sys.videoTexture) {
                        sys.videoTexture.image = previewEl;
                        sys.videoTexture.needsUpdate = true;
                    } else {
                        sys.videoTexture = new THREE.VideoTexture(previewEl);
                        sys.videoTexture.minFilter = THREE.LinearFilter;
                        sys.videoTexture.magFilter = THREE.LinearFilter;
                        sys.videoTexture.format = THREE.RGBFormat;
                    }

                    // æœ‰äº›æ©Ÿå‹éœ€è¦å†è§¸ç™¼ä¸€æ¬¡ play
                    try { await previewEl.play(); } catch (_) { }
                    log('âœ… å·²å°‡ Preview ç¶å®šçµ¦ MindARï¼ˆè‹¥ä»é»‘ï¼Œè«‹ç§»å‹•åˆ° target åœ–ç‰‡è©¦è©¦ï¼‰');
                } catch (e) {
                    log('âŒ ç¶å®šå¤±æ•—ï¼š', String(e));
                }
            };
        })();
    </script>
</body>

</html>