<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
    <title>MindAR 5 Targets — Debug</title>

    <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar-js@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #hud {
            position: fixed;
            left: 8px;
            top: 8px;
            z-index: 10;
            max-width: min(92vw, 600px);
            background: rgba(0, 0, 0, .65);
            color: #fff;
            padding: 10px 12px;
            border-radius: 12px;
            font: 13px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
            white-space: pre-wrap;
            word-break: break-word;
        }

        #startBtn {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            padding: 14px 24px;
            background: #28a745;
            color: #fff;
            border: 0;
            border-radius: 12px;
            z-index: 2147483647;
            pointer-events: auto;
            cursor: pointer;
            touch-action: manipulation;
            user-select: none;
        }
    </style>
</head>

<body>
    <div id="hud">Booting…0.4</div>
    <button id="startBtn">▶ Start AR 0.5</button>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; autoStart: false"
        renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true" embedded
        vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: true">
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0"></a-entity>
        <a-entity mindar-image-target="targetIndex: 1"></a-entity>
        <a-entity mindar-image-target="targetIndex: 2"></a-entity>
        <a-entity mindar-image-target="targetIndex: 3"></a-entity>
        <a-entity mindar-image-target="targetIndex: 4"></a-entity>
    </a-scene>

    <script>
        const hud = document.getElementById('hud');
        const startBtn = document.getElementById('startBtn');
        const sceneEl = document.querySelector('a-scene');
        const log = (...a) => { hud.textContent += '\n' + a.join(' '); console.log(...a); };
        const set = (t) => { hud.textContent = t; console.log(t); };

        // 檢查 targets.mind 是否讀到（方便排錯）
        (async () => {
            set('Checking ./targets.mind …');
            try {
                const r = await fetch('./targets.mind', { cache: 'no-store' });
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const buf = await r.arrayBuffer();
                log(`OK, size=${(buf.byteLength / 1024).toFixed(1)} KB`);
            } catch (e) {
                log('❌ 無法讀取 targets.mind：', String(e));
            }
        })();

        // 產 5 色（互不重複）
        const PALETTE = ['#e74c3c', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#e67e22', '#1abc9c', '#e84393', '#16a085', '#d35400'];
        const colors = (() => { const p = [...PALETTE], out = []; for (let i = 0; i < 5; i++) out.push(p.splice(Math.floor(Math.random() * p.length), 1)[0]); return out; })();

        const targets = Array.from(document.querySelectorAll('[mindar-image-target]'));
        const spawned = new Array(5).fill(null);

        // 只在 scene 完全 loaded 後再掛事件
        sceneEl.addEventListener('loaded', () => {
            log('A-Frame loaded');
            sceneEl.addEventListener('arReady', () => log('✅ arReady（管線啟動）'));
            sceneEl.addEventListener('arError', e => log('❌ arError：', e?.detail || 'unknown'));

            targets.forEach((t, idx) => {
                t.addEventListener('targetFound', () => {
                    log(`found #${idx}`);
                    if (!spawned[idx]) {
                        const s = document.createElement('a-sphere');
                        s.setAttribute('position', '0 0 -0.08');
                        s.setAttribute('radius', '0.035');
                        s.setAttribute('segments-width', '32');
                        s.setAttribute('segments-height', '32');
                        s.setAttribute('material', `color:${colors[idx]}`);
                        t.appendChild(s);
                        spawned[idx] = s;
                    }
                });
                t.addEventListener('targetLost', () => {
                    log(`lost  #${idx}`);
                    if (spawned[idx]) { spawned[idx].remove(); spawned[idx] = null; }
                });
            });

            // ===== 啟動邏輯（保證按得到 + 等系統就緒） =====
            let starting = false, started = false, pollId = null;

            const waitAndStart = () => {
                if (starting || started) return;
                starting = true;
                set('Starting AR…（等待系統就緒）');

                // 每 200ms 檢查一次 system 是否存在
                pollId = setInterval(async () => {
                    const sys = sceneEl.systems && sceneEl.systems['mindar-image-system'];
                    if (!sys) { log('⌛ system 尚未就緒…'); return; }
                    clearInterval(pollId);
                    try {
                        await sys.start();
                        started = true;
                        log('✅ AR started');
                        startBtn.remove(); // 拿掉按鈕
                    } catch (e) {
                        starting = false;
                        log('❌ start 失敗：', e);
                    }
                }, 200);
            };

            // 多種事件都綁上，並阻止事件被 scene 吞掉
            const userGestureHandler = (ev) => {
                try { ev.stopPropagation(); ev.preventDefault(); } catch (_) { }
                waitAndStart();
            };
            startBtn.addEventListener('click', userGestureHandler, { passive: false });
            startBtn.addEventListener('pointerdown', userGestureHandler, { passive: false });
            startBtn.addEventListener('touchend', userGestureHandler, { passive: false });

            // 兜底：點畫面任意處也試一次（有些瀏覽器需要第一下在非按鈕處）
            document.addEventListener('pointerdown', () => {
                if (!started) waitAndStart();
            }, { once: true });

        });

        // 額外測相機權限（log 用）
        navigator.mediaDevices?.getUserMedia({ video: true })
            .then(() => log('✅ 瀏覽器允許相機（測試用）'))
            .catch(err => log('⚠️ 相機權限被拒/無法取得：', err?.name));
    </script>
</body>

</html>